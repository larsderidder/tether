services:
  agent:
    build:
      context: .
      dockerfile: agent/Dockerfile
    ports:
      - "${TETHER_AGENT_PORT:-8787}:8787"
    environment:
      - TETHER_AGENT_TOKEN=${TETHER_AGENT_TOKEN:-}
      - TETHER_AGENT_ADAPTER=${TETHER_AGENT_ADAPTER:-claude_local}
      - TETHER_AGENT_DATA_DIR=/app/data
      - TETHER_AGENT_DEV_MODE=${TETHER_AGENT_DEV_MODE:-}
      # For Claude API adapter
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      # For Codex SDK sidecar adapter
      - TETHER_CODEX_SIDECAR_URL=http://codex-sidecar:8788
    volumes:
      - agent_data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8787/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  codex-sidecar:
    profiles: ["codex"]
    build:
      context: .
      dockerfile: codex-sdk-sidecar/Dockerfile
    environment:
      - TETHER_CODEX_SIDECAR_HOST=0.0.0.0
      - TETHER_CODEX_SIDECAR_PORT=8788
      - TETHER_CODEX_SIDECAR_TOKEN=${TETHER_CODEX_SIDECAR_TOKEN:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - TETHER_CODEX_SIDECAR_MODEL=${TETHER_CODEX_SIDECAR_MODEL:-}
    restart: unless-stopped

volumes:
  agent_data:
    name: tether_agent_data
